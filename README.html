<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>StudyPal — AI Study Buddy</title>
<style>
  :root{--bg:#f6f8fb;--card:#fff;--accent:#4f8cff;--muted:#6b7280}
  *{box-sizing:border-box}
  body{font-family:Inter,Segoe UI,Arial,sans-serif;background:var(--bg);margin:0;color:#0f172a}
  .container{max-width:1100px;margin:24px auto;padding:20px}
  header{display:flex;justify-content:space-between;align-items:center;margin-bottom:18px}
  h1{font-size:1.25rem;margin:0}
  button.btn{background:var(--accent);color:#fff;border:none;padding:8px 12px;border-radius:8px;cursor:pointer}
  button.ghost{background:transparent;border:1px solid #e6eefc;color:var(--accent)}
  section.card{background:var(--card);box-shadow:0 6px 18px rgba(15,23,42,0.06);border-radius:12px;padding:18px;margin-bottom:18px}
  .flex{display:flex;gap:12px;align-items:center}
  .col{display:flex;flex-direction:column;gap:12px}
  .select,textarea,input[type=text]{padding:10px;border-radius:8px;border:1px solid #e6eefc;width:100%}
  .chat-window{height:300px;overflow:auto;padding:10px;border-radius:8px;background:#fbfdff;border:1px solid #eef2ff;display:flex;flex-direction:column;gap:8px}
  .bubble{display:inline-block;padding:10px 12px;border-radius:12px;margin:6px 0;max-width:80%}
  .bubble.ai{background:#f1f8ff;border:1px solid #e6eefc;align-self:flex-start}
  .bubble.user{background:var(--accent);color:#fff;align-self:flex-end}
  .flashcards{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:12px;margin-top:12px}
  .card-fc{padding:12px;border-radius:10px;background:#fff;border:1px solid #eef2ff;cursor:pointer;user-select:none}
  .toast{position:fixed;right:18px;bottom:18px;background:#111;color:#fff;padding:10px 14px;border-radius:8px;opacity:0;transform:translateY(12px);transition:all .28s}
  .toast.show{opacity:1;transform:none}
  .small{font-size:0.9rem;color:var(--muted)}
  .grid-2{display:grid;grid-template-columns:1fr 380px;gap:16px}
  a.resource-link{display:block;color:#0f62ff;margin-bottom:6px;text-decoration:none}
  @media(max-width:820px){.grid-2{grid-template-columns:1fr}}
</style>
</head>
<body>
<div class="container">
  <header>
    <h1>StudyPal — AI Study Buddy</h1>
    <div>
      <button id="themeBtn" class="ghost">Toggle Theme</button>
    </div>
  </header>

  <!-- Focus/Pomodoro -->
  <section class="card" id="focusCard">
    <div class="flex" style="justify-content:space-between">
      <div>
        <h2 style="margin:0">Focus Session</h2>
        <div class="small">Pomodoro timer to help you focus</div>
      </div>
      <div style="text-align:right">
        <div class="small">Mode: <strong id="focusMode">25/5</strong></div>
      </div>
    </div>

    <div style="display:flex;gap:20px;align-items:center;margin-top:12px">
      <div style="width:140px;height:140px;display:grid;place-items:center;border-radius:12px;background:#fff;border:1px solid #eef2ff">
        <div style="text-align:center">
          <div id="timeDisplay" style="font-size:28px;font-weight:600">25:00</div>
          <div style="font-size:12px;color:#64748b">Focus</div>
        </div>
      </div>

      <div style="flex:1">
        <div style="display:flex;gap:8px">
          <button class="btn" id="startFocus">Start</button>
          <button class="btn" id="pauseFocus">Pause</button>
          <button class="btn" id="resetFocus">Reset</button>
          <select id="focusSelect" class="select" style="width:150px">
            <option value="25">25 min focus / 5 break</option>
            <option value="50">50 min focus / 10 break</option>
            <option value="15">15 min focus / 3 break</option>
          </select>
        </div>
        <div style="margin-top:10px" class="small">Use focus sessions to block distractions and study with Pomodoro.</div>
      </div>
    </div>
  </section>

  <!-- Lesson + Flashcards + Chat -->
  <section class="card">
    <div class="grid-2">
      <div>
        <h2 style="margin-top:0">Lesson / Flashcards</h2>
        <div class="small" style="margin-bottom:8px">Paste your lesson text</div>
        <textarea id="lessonText" rows="8" placeholder="Paste lesson text here..." class="select"></textarea>
        <div style="display:flex;gap:8px;margin-top:8px">
          <button class="btn" id="genFlash">Generate Flashcards</button>
          <button class="btn" id="askSummary">Ask AI (Summary)</button>
          <button class="ghost" id="clearLesson">Clear</button>
        </div>

        <div id="flashcards" class="flashcards"></div>
      </div>

      <aside>
        <h2 style="margin-top:0">AI Chat</h2>
        <div class="chat-window" id="chatWindow" role="log" aria-live="polite"></div>
        <div style="display:flex;gap:8px;margin-top:8px">
          <input id="chatInput" type="text" placeholder="Ask the AI a study question..." class="select" style="flex:1"/>
          <button class="btn" id="sendChat">Send</button>
        </div>

        <h3 style="margin-top:12px">Resources</h3>
        <div id="resources" class="small"></div>
      </aside>
    </div>
  </section>

  <footer style="text-align:center;color:#64748b;margin-top:8px">© StudyPal • Demo</footer>
</div>

<div id="toast" class="toast"></div>

<script>
/* === CONFIG ===
 Replace with your OpenAI API key before uploading.
 WARNING: embedding the key in client HTML is NOT secure for public sites.
 For private demos it's OK; for public use, request a serverless/backend solution.
*/
const OPENAI_API_KEY = "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


";

/* small helpers */
function toast(msg, t=3000){ const el=document.getElementById('toast'); el.textContent=msg; el.classList.add('show'); setTimeout(()=>el.classList.remove('show'), t); }

/* theme toggle */
document.getElementById('themeBtn').addEventListener('click', ()=> document.body.classList.toggle('dark-mode'));

/* ===== Focus / Pomodoro ===== */
let focusMinutes = 25, breakMinutes = 5;
let totalSeconds = focusMinutes*60, remaining = totalSeconds;
let running=false, onBreak=false, intervalId=null;
const timeDisplay = document.getElementById('timeDisplay');
const focusSelect = document.getElementById('focusSelect');
const focusMode = document.getElementById('focusMode');

function updateTimeUI(){
  const mm = String(Math.floor(remaining/60)).padStart(2,'0');
  const ss = String(remaining%60).padStart(2,'0');
  timeDisplay.textContent = `${mm}:${ss}`;
  focusMode.textContent = `${focusMinutes}/${breakMinutes}`;
}
function setDur(min){
  focusMinutes = parseInt(min,10);
  breakMinutes = (focusMinutes===50)?10:(focusMinutes===15?3:5);
  totalSeconds = focusMinutes*60;
  remaining = totalSeconds;
  onBreak=false;
  updateTimeUI();
}
focusSelect.addEventListener('change', e=> setDur(e.target.value));
setDur(focusSelect.value);

function tick(){
  if(remaining>0){ remaining--; updateTimeUI(); }
  else {
    if(!onBreak){ onBreak=true; totalSeconds = breakMinutes*60; remaining=totalSeconds; toast('Break time!'); }
    else { onBreak=false; totalSeconds = focusMinutes*60; remaining=totalSeconds; toast('Focus time!'); }
    updateTimeUI();
  }
}

document.getElementById('startFocus').addEventListener('click', ()=>{
  if(running) return; running=true; intervalId = setInterval(tick,1000); toast('Started');
});
document.getElementById('pauseFocus').addEventListener('click', ()=>{ running=false; clearInterval(intervalId); toast('Paused'); });
document.getElementById('resetFocus').addEventListener('click', ()=>{ running=false; clearInterval(intervalId); onBreak=false; setDur(focusSelect.value); toast('Reset'); });

/* ===== UI references for AI/flashcards ===== */
const chatWindow = document.getElementById('chatWindow');
const chatInput = document.getElementById('chatInput');
const sendChatBtn = document.getElementById('sendChat');
const genFlashBtn = document.getElementById('genFlash');
const askSummaryBtn = document.getElementById('askSummary');
const lessonText = document.getElementById('lessonText');
const flashcardsEl = document.getElementById('flashcards');
const resourcesEl = document.getElementById('resources');

function appendBubble(text, who='ai'){
  const d = document.createElement('div');
  d.className = 'bubble ' + (who==='ai' ? 'ai' : 'user');
  d.textContent = text;
  chatWindow.appendChild(d);
  chatWindow.scrollTop = chatWindow.scrollHeight;
}

/* ===== Media/link helpers ===== */
function youtubeSearchUrl(q){ return `https://www.youtube.com/results?search_query=${encodeURIComponent(q)}`; }
function imageSearchUrl(q){ return `https://www.google.com/search?tbm=isch&q=${encodeURIComponent(q)}`; }
function unsplashSearchUrl(q){ return `https://unsplash.com/s/photos/${encodeURIComponent(q)}`; }

function detectMediaRequest(text){
  const t = (text||'').toLowerCase();
  const wantSound = /\b(sound|audio|music|calm|relax(ing|ation)|white noise|rain|ocean|sleep)\b/;
  const wantImage = /\b(picture|image|photo|photo(s)?|picture(s)?|image(s)?|illustration|diagram|diagram(s)?)\b/;
  if(wantSound.test(t)) return {type:'sound'};
  if(wantImage.test(t)) return {type:'image'};
  return null;
}

function insertMediaLinks(kind, term='relaxing'){
  // clear resources for new result
  // (keeps UI tidy on each media request)
  resourcesEl.innerHTML = '';
  if(kind === 'sound'){
    const items = [
      {title: 'Calming nature sounds (YouTube)', url: youtubeSearchUrl(term + ' calming sounds')},
      {title: 'White noise / sleep sounds (YouTube)', url: youtubeSearchUrl('white noise sleep')},
      {title: 'Ocean / rain sounds (YouTube)', url: youtubeSearchUrl('ocean waves rain sounds')}
    ];
    items.forEach(it=>{
      const a = document.createElement('a'); a.href = it.url; a.textContent = it.title; a.target = '_blank'; a.className='resource-link'; resourcesEl.appendChild(a);
    });
    appendBubble(`I added sound video search links to Resources. Top result: ${items[0].title}`, 'ai');
    appendBubble(items[0].url, 'ai');
  }
  if(kind === 'image'){
    const items = [
      {title: 'Nature images (Google Images)', url: imageSearchUrl('relaxing nature')},
      {title: 'Study space photos (Unsplash)', url: unsplashSearchUrl('study space')},
      {title: 'Diagrams / illustrations (Google Images)', url: imageSearchUrl('biology diagram')}
    ];
    items.forEach(it=>{
      const a = document.createElement('a'); a.href = it.url; a.textContent = it.title; a.target = '_blank'; a.className='resource-link'; resourcesEl.appendChild(a);
    });
    appendBubble(`I added image search links to Resources. Top result: ${items[0].title}`, 'ai');
    appendBubble(items[0].url, 'ai');
  }
}

/* ===== OpenAI call (browser) ===== */
async function callOpenAIChat(prompt, opts={}) {
  if(!OPENAI_API_KEY || OPENAI_API_KEY === 'PASTE-YOUR-OPENAI-API-KEY-HERE') throw new Error('No API key set. Paste your OpenAI key into the file.');

  const body = {
    model: opts.model || "gpt-3.5-turbo",
    messages: [
      { role: "system", content: opts.system || "You are a helpful study assistant. Answer concisely and logically." },
      { role: "user", content: prompt }
    ],
    temperature: opts.temperature ?? 0.3,
    max_tokens: opts.max_tokens ?? 800
  };

  const resp = await fetch("https://api.openai.com/v1/chat/completions", {
    method: "POST",
    headers: {
      "Content-Type":"application/json",
      "Authorization": `Bearer ${OPENAI_API_KEY}`
    },
    body: JSON.stringify(body)
  });

  if(!resp.ok){
    const txt = await resp.text();
    throw new Error(`OpenAI error ${resp.status}: ${txt}`);
  }
  const j = await resp.json();
  return j.choices?.[0]?.message?.content || '';
}

/* ===== Chat send (merged with media auto-links) ===== */
sendChatBtn.addEventListener('click', async ()=>{
  const q = chatInput.value.trim();
  if(!q) return;
  appendBubble(q,'user');
  chatInput.value = '';
  appendBubble('...', 'ai'); // placeholder

  try{
    // quick media detection & immediate resource insertion (so user sees links fast)
    const media = detectMediaRequest(q);
    if(media){
      // choose a helpful search term based on content
      const term = media.type === 'sound' ? 'relaxing sounds' : 'relaxing images';
      insertMediaLinks(media.type, term);
      // still call OpenAI for fuller answer / context below
    }

    const ans = await callOpenAIChat(q, {temperature:0.4});
    const nodes = chatWindow.querySelectorAll('.bubble.ai');
    if(nodes.length) nodes[nodes.length-1].textContent = ans;
  } catch(e){
    const nodes = chatWindow.querySelectorAll('.bubble.ai');
    if(nodes.length) nodes[nodes.length-1].textContent = 'Error: ' + e.message;
    else appendBubble('Error: ' + e.message, 'ai');
  }
});

/* ===== Generate flashcards ===== */
genFlashBtn.addEventListener('click', async ()=>{
  const text = (lessonText.value || '').trim();
  if(!text) return toast('Paste lesson text first');
  toast('Generating flashcards...');
  try{
    const prompt = `Extract up to 8 concise Q&A flashcards from the following lesson. Output exactly as a JSON array: [{"q":"...","a":"..."}]\n\nLesson:\n${text}`;
    const resp = await callOpenAIChat(prompt, {temperature:0.2, max_tokens:800});
    let arr;
    try { arr = JSON.parse(resp); }
    catch(e){
      const start = resp.indexOf('[');
      const end = resp.lastIndexOf(']') + 1;
      if(start !== -1 && end !== 0){
        arr = JSON.parse(resp.slice(start,end));
      } else {
        arr = [];
        const lines = resp.split(/\r?\n/).filter(Boolean);
        for(const line of lines){
          const mq = line.match(/Q[:\-]\s*(.*)/i);
          const ma = line.match(/A[:\-]\s*(.*)/i);
          if(mq && ma) arr.push({q: mq[1].trim(), a: ma[1].trim()});
        }
      }
    }
    renderFlashcards(arr || []);
    toast('Flashcards ready');
  } catch(err){
    toast('Flashcard generation failed: ' + err.message);
    console.error(err);
  }
});

/* Ask summary */
askSummaryBtn.addEventListener('click', async ()=>{
  const text = (lessonText.value || '').trim();
  if(!text) return toast('Paste lesson text first');
  appendBubble('Please summarize the lesson (4 short bullet points).','user');
  appendBubble('...', 'ai');
  try{
    const ans = await callOpenAIChat(`Summarize the following lesson in 4 short bullet points:\n\n${text}`, {temperature:0.2});
    const nodes = chatWindow.querySelectorAll('.bubble.ai');
    if(nodes.length) nodes[nodes.length-1].textContent = ans;
  } catch(e){
    const nodes = chatWindow.querySelectorAll('.bubble.ai');
    if(nodes.length) nodes[nodes.length-1].textContent = 'Error: ' + e.message;
  }
});

/* ===== Render flashcards ===== */
function renderFlashcards(list){
  flashcardsEl.innerHTML = '';
  if(!Array.isArray(list) || list.length === 0){
    flashcardsEl.innerHTML = '<div class="small">No flashcards generated yet</div>';
    return;
  }
  list.forEach(it => {
    const div = document.createElement('div');
    div.className = 'card-fc';
    div.tabIndex = 0;
    div.innerHTML = `<strong>Q:</strong> ${escapeHtml(it.q||'')}<div style="margin-top:8px;color:#64748b"><strong>A:</strong> <span class="fc-a">${escapeHtml(it.a||'')}</span></div>`;
    const ansSpan = div.querySelector('.fc-a');
    ansSpan.style.visibility = 'hidden';
    div.addEventListener('click', ()=> {
      ansSpan.style.visibility = ansSpan.style.visibility === 'hidden' ? 'visible' : 'hidden';
    });
    flashcardsEl.appendChild(div);
  });
}

/* small escape for HTML injection safety */
function escapeHtml(s){ return String(s).replace(/[&<>"']/g, c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[c])); }

/* Enter key to send chat */
chatInput.addEventListener('keydown', (e)=> { if(e.key==='Enter'){ sendChatBtn.click(); e.preventDefault(); } });

/* Clear lesson */
document.getElementById('clearLesson').addEventListener('click', ()=> { lessonText.value=''; flashcardsEl.innerHTML=''; resourcesEl.innerHTML=''; });

</script>
</body>
</html>
